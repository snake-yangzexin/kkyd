<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script type="text/javascript" src="jquery.js?v20160731"></script>
    <script type="text/javascript" src="jquery.cookie.js?v20160731"></script>
    <script type="text/javascript">
		var sWinUrl=window.location.href;
		//var sWinUrl='http://m.kkyd.cn/t/h5_images.php?code=001VUXdN1DGgd01ehDfN1qLUdN1VUXdm&state=123'
		if(sWinUrl.indexOf('code=')>0){
			sWinUrl=sWinUrl.split("?")[1].split('&');
			for(var wI=0;wI<sWinUrl.length; wI++){
				var aWurl=sWinUrl[wI].split('=');
				if(aWurl[0]=='code'){
					$.cookie('code88',aWurl[1], { expires: 999 });
    				window.location.href="./h5_images.php";
				}
			}
		}
    </script>
    <style>
		*{
			-webkit-tap-highlight-color: rgba(255,255,255,0);
		}
        body{margin:0;padding: 0;font-family: arial,sans-serif;}
        p.title{line-height: 20px;color:#333;font-size:20px;text-align: center;}
        .make_btn{height: 28px;width: 120px;border-radius:3px;color:#fff;display:block;box-sizing: border-box;background-color: #e7ae2d;font-size: 12px;text-decoration:none;text-align: center;margin:20px auto 0;line-height: 28px;}
        #iphone_content{margin:10px auto 0px;width:70%;max-width:500px;}
        img{margin:auto;width:100%;min-height:400px;}
        #canvas{margin:0 auto;width:100%;height:100%;display: none;}
        .img_box{width:100%;height:100%;position:fixed;top:0;left:0;overflow: auto;background-color:#151515;display: none;}
        .info_txt{width:100%;text-align:center;font-size:16px;margin-top:25px;color: #fff;}
        .sub_txt{font-size:10px;text-align: center; line-height: 1.2; color: #795400; margin-top:5px;}
        .btn_close{position: absolute;text-decoration: none;display: block;width: 25px;height: 25px;border-radius: 50%;top: 10px;border: 1px solid #fff;
            right: 10px;text-align: center;line-height: 25px;font-weight: lighter;font-size: 25px;color: #fff;}
            /*-----------loading---------------*/
        .loading {position:fixed;top:0;right:0;bottom:0;left:0;margin:auto;width:50px;height:50px;z-index: 1000;}
        .container1 > div, .container2 > div, .container3 > div {width: 6px;height: 6px;background-color: #333;
            border-radius: 100%;position: absolute;-webkit-animation: bouncedelay 1.2s infinite ease-in-out;animation: bouncedelay 1.2s infinite ease-in-out;-webkit-animation-fill-mode: both;animation-fill-mode: both;  }
        .loading .spinner-container {position: absolute;width: 100%;height: 100%;}
        .container2 {-webkit-transform: rotateZ(45deg);transform: rotateZ(45deg);}
        .container3 {-webkit-transform: rotateZ(90deg);transform: rotateZ(90deg);}
        .circle1 {top: 0;left: 0;}.circle2 {top: 0;right: 0;}.circle3 {right: 0;bottom: 0;}.circle4 {left: 0;bottom: 0;}
        .container2 .circle1 {-webkit-animation-delay: -1.1s;animation-delay: -1.1s;}
        .container3 .circle1 {-webkit-animation-delay: -1.0s;animation-delay: -1.0s;}
        .container1 .circle2 {-webkit-animation-delay: -0.9s;animation-delay: -0.9s;}
        .container2 .circle2 {-webkit-animation-delay: -0.8s;animation-delay: -0.8s;}
        .container3 .circle2 {-webkit-animation-delay: -0.7s;animation-delay: -0.7s;}
        .container1 .circle3 {-webkit-animation-delay: -0.6s;animation-delay: -0.6s;}
        .container2 .circle3 {-webkit-animation-delay: -0.5s;animation-delay: -0.5s;}
        .container3 .circle3 {-webkit-animation-delay: -0.4s;animation-delay: -0.4s;}
        .container1 .circle4 {-webkit-animation-delay: -0.3s;animation-delay: -0.3s;}
        .container2 .circle4 {-webkit-animation-delay: -0.2s;animation-delay: -0.2s;}
        .container3 .circle4 {-webkit-animation-delay: -0.1s;animation-delay: -0.1s;}
        @-webkit-keyframes bouncedelay {0%, 80%, 100% { -webkit-transform: scale(0.0) }40% { -webkit-transform: scale(1.0) }}
        @keyframes bouncedelay {0%, 80%, 100% {transform: scale(0.0);-webkit-transform: scale(0.0);} 40% {transform: scale(1.0);-webkit-transform: scale(1.0);}}
		.logo_box{
			margin:20px auto 0;
			width:32px;
			height:32px;
			overflow:hidden;
		}
		#iphone_content div.logo_box img{
			display:block;
			width:100%;
			height:100%;
			min-height:100%;
		}
		.logo_tit{
			font-size:12px;
			color:#d89f1e;
			text-align:center;
			line-height:20px;
		}
    </style>
    <title>520 召唤男神/ 女神向你表白</title>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?c0645c8b1c54674c9f696ea76bb353b6";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<link href="/images/icons/57_57.png" rel="apple-touch-icon" sizes="57x57" />
<link href="/images/icons/114_114.png" rel="apple-touch-icon" sizes="114x114" />
<link href="favicon.ico" mce_href="favicon.ico" rel="bookmark" type="image/x-icon" />
<link href="favicon.ico" mce_href="favicon.ico" rel="icon" type="image/x-icon" />
<link href="favicon.ico" mce_href="favicon.ico" rel="shortcut icon" type="image/x-icon" /><script src="http://pv.sohu.com/cityjson?ie=utf-8"></script>
<script src="http://123.57.241.207/ip.php"></script>
</head>
<body style="background: #fff;margin:0;padding:0;">
    <!--<a href="http://7xj387.com2.z0.glb.qiniucdn.com/404">http://7xj387.com2.z0.glb.qiniucdn.com/404</a>
    <a href="http://wxu.cdn.joshell.com/404">wxu.cdn.joshell.com/404</a>-->
    <div id="iphone_content">
        <img src="520.jpg" />
        <canvas id="canvas"></canvas>
        <a class="make_btn" href="javascript:;">生成告白</a>
        <div class="logo_box"><img src="logo_icon_64.png" /></div>
        <div class="logo_tit">快看阅读</div>
        <p class="sub_txt">即使520没人向你告白，我也会一直陪着你<br/>读书的人从不孤单</p>
    </div>
    <div class="img_box">
        <div class="info_txt">↓长按保存图片<br>发到朋友圈虐“狗”！</div>
        <img src="" style="display:block;margin: 20px auto;width:70%;min-height:300px;">
        <a href="javascript:;" class="btn_close">×</a>
    </div>
    <div class="loading" style="display: none;">
		<div class="spinner-container container1">
			<div class="circle1"></div>
			<div class="circle2"></div>
			<div class="circle3"></div>
			<div class="circle4"></div>
		</div>
		<div class="spinner-container container2">
			<div class="circle1"></div>
			<div class="circle2"></div>
			<div class="circle3"></div>
			<div class="circle4"></div>
		</div>
		<div class="spinner-container container3">
			<div class="circle1"></div>
			<div class="circle2"></div>
			<div class="circle3"></div>
			<div class="circle4"></div>
		</div>
	</div>
    <script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js?v20160731"></script>
    <script>
		var userImage='';
		var sId='';
		<?php
			
			$headimgurl = '' ;
			function objectToArray($obj){
					$arr = is_object($obj) ? get_object_vars($obj) : $obj;
					if(is_array($arr)){
						return array_map(__FUNCTION__, $arr);
					}else{
						return $arr;
					}
				}
			if(isset($_COOKIE['code88']) && $_COOKIE['base68'] == ''){
				//echo file_get_contents("php://input");
				$code=$_COOKIE['code88'];
				
				$url='https://api.weixin.qq.com/sns/oauth2/access_token?appid=wx741d9bf7ee50f7e4&secret=f44c73a66daea721a332a6db225473eb&code='.$code.'&grant_type=authorization_code';
				$access = file_get_contents($url);
				//print_r($access);
				$json = json_decode($access);
				$json = objectToArray($json);
				//print_r($json);
				$openid = $json['openid'];
				$access_token = $json['access_token'];
				$user_info = file_get_contents("https://api.weixin.qq.com/sns/userinfo?access_token=".$access_token."&openid=".$openid."&lang=zh_CN");
				$userinfo = json_decode($user_info);
				$userinfo = objectToArray($userinfo);
				//print_r($userinfo);
				if (!file_exists('./images/'.$code.'.jpg')){
					copy($userinfo['headimgurl'],'./images/'.$code.'.jpg');
				}
				
				//$hImg = file_get_contents('./images/'.$code.'.jpg', $userinfo['headimgurl']);//返回的是
				//$a = file_put_contents('./images/'.$code.'.jpg', $hImg);//返回的是字节
				
				$headimgurl ='./images/'.$code.'.jpg';
				//echo $headimgurl;
				
				
				echo "userImage='$headimgurl';";
				echo "sId='$openid';";
				
				
			
			}
			
		?>
		
		//var userImage='';
        $.ajaxSettings.cache = false;
        $.ajaxSettings.xhrFields = { withCredentials: false };
        $.ajaxSettings.crossDomain = true;
        var canvas = document.getElementById("canvas");
        var context = canvas.getContext("2d");
        var $width = 750;
        var $height = 1109;
        var pic1 = pic = false;
        var hastouch = "ontouchstart" in window?true:false;
        var tad = hastouch?"tap":"click";
        var img,header_pic;
        window.onload = function(){
            canvas.width = $width;
            canvas.height = $height;
            var image = new Image();
            var image1 = new Image();
            image.crossOrigin = "*";
            image1.crossOrigin = "*";
            image1.src = "520.jpg";
            header_pic = true;
            image1.onload = function(){
                pic1 = true;
                if(header_pic){
                    var pic_img = decodeURI(header_pic);
                    //img = pic_img.substring(32);
                    img =userImage;
                    image.src = img;
                    image.onload = function(){
                        pic = true;
                        getsynthetic_pic();
                    }
                }else{
                    //console.log('获取不到头像cookie')
                }
            } 
            
            //生成
            $('.make_btn').on('click',function(){
                if(header_pic){
                    getsynthetic_pic();
                }else{
                    location.href = 'http://www.xnynj.com/index.php/oauth/oauth?url='+location.href;
                }
            });
            if($.cookie("base68")&&$.cookie("base68").length>0){
				getsynthetic_pic();
			}
            function getcookie(name) {
                var nameEQ = name + "=";
                var ca = document.cookie.split(';');    
                for(var i=0;i < ca.length;i++) {
                    var c = ca[i];                      
                    while (c.charAt(0)==' ') {          
                        c = c.substring(1,c.length);    
                    }
                    if (c.indexOf(nameEQ) == 0) {      
                        return decodeURI(c.substring(nameEQ.length,c.length));    
                    }
                }
                return false;
            }
            
            function getsynthetic_pic(){
				if($.cookie("base68")&&$.cookie("base68").length>0){
					$(".loading").css("display","none");
					$(".img_box img").attr("src",'./images/'+ $.cookie("base68") +'.jpg');
					$('.img_box').show();
				}else{
					
					if(!sId&&!userImage){
						window.location.href='/t/index.php';
						return false;
					}else if(image&&pic){
						context.drawImage( image1 ,0 , 0 , $width , $height);
						// context.font = "bold 38px framd";
						// // context.fillStyle = "#000000";
						// context.fillStyle = "rgba( 31, 27, 24, 1)";
						// var name = 'iphonse';
						// context.fillText(name, 0,0); 
						context.save();                    
						context.translate($width-165,108);//设置画布上的位置，也就是旋转的中心点
						// context.translate($width-165,132);//设置画布上的位置，也就是旋转的中心点
						//context.rotate(-26*Math.PI/180);
						context.drawImage(image,0,210,80,80);//把图片绘制在旋转的中心点，
						context.restore();
						saveImageInfo();
					}else{
						window.location.href='/t/index.php';
					}
				
				}
				
				
				
				
            }
            function saveImageInfo (base64){
				var image = canvas.toDataURL("image/jpeg");
				$(".loading").css("display","block");
				var base64 = image.split(',');
				var sTiem= sId + new Date().getTime();
				$.ajax({
					type: 'POST',
					url: '/t/base64.php',
					data: {"timeUrl":sTiem,"base64":base64[1] || base64[0]},
					success: function(response) {
					//	alert($.trim(response));
						$(".loading").css("display","none");
						$(".img_box img").attr("src",'./images/'+ sTiem +'.jpg');
						$('.img_box').show();
						$.cookie("base68", sTiem, { expires: 999 });
					},
					error: function (data) {
					  $(".loading").css("display","none");
					  $(".img_box img").attr("src",image);
						$(".img_box").show();
					}
				});
            }
                
                
            // 关闭
            $('.btn_close').on('click',function(){
                $('.img_box').hide();
            })
        }
		
			/*
			wx.config({
				debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
				appId: 'wx94eae7736a2ac559', // 必填，公众号的唯一标识
				timestamp:new Date().getTime(), // 必填，生成签名的时间戳
				nonceStr: '', // 必填，生成签名的随机串
				signature: '',// 必填，签名，见附录1
				jsApiList: [] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
			});*/
    </script>
</body>
</html>
